<!-- users.js calls this homepage! 
  - make get req in my own API
  - need to make HTTP call to my own server 
-->

<!DOCTYPE html>
<html>
  <head>
    <style>
      /* Set the size of the div element that contains the map */
      #map {
        /* 400px by 100% */
        /* change to fullscreen: 1600px by 1200% when done */
        height: 600px;
        /* The height is 400 pixels */
        width: 1000px;
        /* The width is the width of the web page */
      }

    </style>
  </head>
  <body>
    <h3>Here is your checklist!</h3>
    <!--The div element for the map -->
    <div id="map"></div>
    <script>
      //the cookies are a global variable. they need to be parsed 
      var decodedCookie = decodeURIComponent(document.cookie);
      var cookiedata = decodedCookie.split(';');
      var parsedCookie = JSON.parse(cookiedata[2])
    
      //parsing the cookie into a string. didnt have to pass in any variable bc its a global variable 
      function getUserData() {
        var name = "userData=";
        var cookiedata = decodeURIComponent(document.cookie);
        var ca = cookiedata.split(';');
        for(var i = 0; i < ca.length; i++) {
          var c = ca[i].trim();
          if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
          }
        }
        return "";
      }

      // fetch func = asynchronous so that all my data is retrieved and completed before initializing map
    async function initData() {
      const response = await fetch('http://localhost:3000/coins/all');
      const json = response.json();
      console.log(json);
      return json;
    }

    //define function for the checkbox 
    function myFunction() {
      var checkBox = document.getElementById("myCheck");
      // var text = document.getElementById("text");
      if (checkBox.checked == true){
        // text.style.display = "block";
        console.log("you checked coin1")
      }
      else {
        text.style.display = "none";
        console.log("you unchecked coin1")
      }
    }
    async function myFunctionTwo() {
      var checkBoxTwo = document.getElementById("myCheckTwo");
      if (checkBoxTwo.checked == true){
        console.log("you checked coin2")
      } else {
        text.style.display = "none";
        console.log("you unchecked coin2")
      }
    }
    async function myFunctionThree() {
      var checkBoxThree = document.getElementById("myCheckThree");
      if (checkBoxThree.checked == true){
        console.log("you checked coin3")
      } else {
        text.style.display = "none";
        console.log("you unchecked coin3")
      }
    }

    // getting data from my own API (initData()) to build map 
    async function initMap(data) {
      var loggedUserName = getUserData(); 
      var parsedUserName = JSON.parse(loggedUserName); 
      alert("you are logged in as " + parsedUserName.username);

      var data = await initData(data);
      console.log(data)
      // console.log('the length of array is : ' + data.length);

      var dland = { lat: 33.812, lng: -117.918 };
      var hypsmtn = { lat: 33.811, lng: -117.918 };

      // The map, centered at dland
      var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 17, center: dland});
      var k;
      var coin1 = "";
      var coin2 = "";
      var coin3 = "";     

      for (i in data) {
        const currentMarker = { lat: parseFloat(data[i].col_n), lng: parseFloat(data[i].col_w) };
        // console.log(currentMarker);
        const marker2 = new google.maps.Marker({ position: currentMarker, map: map });

        if (i && (i % 3 === 0)){
          // should clear all coins 
          coin1 = "";
          coin2 = "";
          coin3 = "";  
        }
        if (!coin1){
          coin1 = data[i].coinname;
        }
        else if (!coin2 && (coin2 != coin1)) {
          coin2 = data[i].coinname;
        }
        else if (!coin3 && (coin3 != coin2) && (coin3 != coin1)) {
          coin3 = data[i].coinname;
        }    
        const name = data[i].machinename;
        //no idea what line below does... 
        // document.getElementById("mytext").innerHTML = test;//Now you get the js variable inside your form element

        const contentString2 = '<div id="content">' +
          '<div id="siteNotice">' +
          '</div>' +
          '<h1 id="firstHeading" class="firstHeading">' + name + '</h1>' +
          '<div id="bodyContent">' +
          '<p>' + coin1 + '</p>' +
          '<input type="checkbox" id="myCheck"  onclick="myFunction()"> ' 
            + '<p id="text" style="display:none">CHECKED!</p>' 
            + '<br> <p>' 
            + coin2 
            + '</p> <input type="checkbox" id="myCheckTwo"  onclick="myFunctionTwo()"> '
            + '<p id="text" style="display:none">CHECKED!</p>'
            + '<br> <p>' 
            + coin3 + '</p>' 
            + '<input type="checkbox" id="myCheckThree"  onclick="myFunctionThree()"> ' 
            + '<p id="text" style="display:none">CHECKED!</p>' 
            + '<br>' 
            + '</div>' +
          '</div>';
        //code below will show up in the google maps info window 
        const infowindow = new google.maps.InfoWindow({
          content: contentString2,
          maxWidth: 300
        });

        marker2.addListener('click', () => {
          infowindow.open(map, marker2);
        });
    }
  }

  module.exports = router   //might not be necessary 

  </script>
    <!--Load the API from the specified URL
    * The async attribute allows the browser to render the page while the API loads
    * The callback parameter executes the initMap() function
    -->
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBt2uGZOui5nESr2PwoRVJxP2OUqYA-gp8&callback=initMap">
    </script>
  </body>
</html>
